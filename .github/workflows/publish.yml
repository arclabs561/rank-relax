name: Publish

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check version consistency
        run: |
          ROOT_VERSION=$(grep '^version = ' Cargo.toml | cut -d'"' -f2)
          CRATE_VERSION=$(grep '^version = ' Cargo.toml | grep -o '".*"' | tr -d '"' || echo "workspace")
          PYTHON_VERSION=$(grep '^version = ' rank-relax-python/pyproject.toml | cut -d'"' -f2)
          
          if [ "$CRATE_VERSION" = "workspace" ]; then
            echo "✅ Crate uses workspace version"
          elif [ "$CRATE_VERSION" != "$ROOT_VERSION" ]; then
            echo "❌ Version mismatch: root=$ROOT_VERSION, crate=$CRATE_VERSION"
            exit 1
          fi
          
          if [ "$PYTHON_VERSION" != "$ROOT_VERSION" ]; then
            echo "❌ Version mismatch: root=$ROOT_VERSION, python=$PYTHON_VERSION"
            exit 1
          fi
          
          echo "✅ All versions match: $ROOT_VERSION"
      - name: Run tests
        run: cargo test
      - name: Run clippy
        run: cargo clippy -- -D warnings
      - name: Check formatting
        run: cargo fmt --check --all
      - name: Test with candle feature
        run: cargo test --features candle
        continue-on-error: true
        name: Test candle feature
      - name: Report candle feature status
        if: failure()
        run: echo "⚠️ Candle feature test failed - check logs above"

  publish-crate:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@v1
        id: auth
      - name: Publish to crates.io
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  publish-python:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install maturin
        run: uv tool install maturin
      - name: Verify Python package structure
        working-directory: rank-relax-python
        run: |
          if [ ! -f "pyproject.toml" ]; then
            echo "❌ pyproject.toml not found"
            exit 1
          fi
          echo "✅ Python package structure verified"
      - name: Build and publish to PyPI
        working-directory: rank-relax-python
        uses: pypa/gh-action-pypi-publish@release/v1
        # Note: Uses pending trusted publisher - project will be auto-created on first publish

