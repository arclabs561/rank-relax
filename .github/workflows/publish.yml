name: Publish to PyPI

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # For trusted publishing
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      
      - name: Install maturin
        run: |
          pip install maturin
      
      - name: Build wheel
        working-directory: rank-relax-python
        run: |
          maturin build --release
      
      - name: Publish to PyPI
        working-directory: rank-relax-python
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          maturin publish --username __token__ --password $MATURIN_PYPI_TOKEN
      
      - name: Verify installation
        run: |
          pip install rank-relax
          python -c "import rank_relax; print(f'âœ… rank-relax {rank_relax.__version__} installed')"
